#!/usr/bin/env node

var config = require('../src/config/config.js');

var portfinder = require('portfinder');

var MAX_PORT = 65535
  , MIN_PORT = 1
  , BASE_PORT = config.cli.port;

var argv = require('yargs').usage('Usage: $0 -x [num] -y [num]', {
  p: {
      alias: 'port'
    , default: BASE_PORT
  },

  a: {
      alias: 'assets'
    , default: config.cli.assets
  },

  c: {
      alias: 'content'
    , default: config.cli.content
  },

  g: {
      alias: 'globals'
    , default: config.cli.globals
  },

  t: {
      alias: 'theme'
    , default: config.cli.theme
  },

  l: {
      alias: 'livereloadport'
    , default: config.cli.livereloadport
  },

  s: {
      alias: 'static' // no watching or livereload
    , default: config.cli.static
  },

  r: {
      alias: 'remotecontrol'
    , default: config.cli.remotecontrol
  },
}).argv;

function validPort(port) {
  port = parseInt(port, 10);
  return !isNaN(port) && port >= MIN_PORT && port <= MAX_PORT;
}

function loadServer() {
  require('../src/server/www.js').start(argv, function(err) {
    if (err) throw err;
    console.log('Server listening on http://127.0.0.1:%s/', argv.port);
  });
}

if (!validPort(argv.port)) {
  argv.port = BASE_PORT;
}

if (!validPort(argv.livereloadport)) {
  portfinder.basePort = argv.port + 1000;
  portfinder.getPort(function(err, port) {
    if (err) throw err;
    argv.livereloadport = port;
    loadServer();
  });
}
else {
  loadServer();
}
