#!/usr/bin/env node

var config = require('../src/config/config.js');

var portfinder = require('portfinder');

var MAX_PORT = 65535
  , MIN_PORT = 1
  , BASE_PORT = config.cli.serve.port || 8000;

var argv = require('yargs').usage('Usage: $0 -x [num] -y [num]', {
  p: {
      alias: 'port'
    , default: BASE_PORT
  },

  w: {
      alias: 'workers'
    , default: config.cli.serve.workers || 0
  },

  c: {
      alias: 'content'
    , default: config.cli.serve.content || 'content'
  },

  t: {
      alias: 'theme'
    , default: config.cli.serve.theme || null
  },

  l: {
      alias: 'livereloadport'
    , default: config.cli.serve.livereloadport || 'auto'
  },

  s: {
      alias: 'static' // no watching
    , default: config.cli.serve.static || null
  },

  r: {
      alias: 'remotecontrol'
    , default: 'remotecontrol' in config.cli.serve ? config.cli.serve.remotecontrol : true
  },
}).argv;

function validPort(port) {
  port = parseInt(port, 10);
  return !isNaN(port) && port >= MIN_PORT && port <= MAX_PORT;
}

function loadServer() {
  require('../src/server/www.js').start(argv, function(err) {
    if (err) throw err;
    console.log('Server listening on http://127.0.0.1:%s/', argv.port);
  });
}

if (!validPort(argv.port)) {
  argv.port = BASE_PORT;
}

if (!validPort(argv.livereloadport)) {
  portfinder.basePort = argv.port + 1000;
  portfinder.getPort(function(err, port) {
    if (err) throw err;
    argv.livereloadport = port;
    loadServer();
  });
}
else {
  loadServer();
}
